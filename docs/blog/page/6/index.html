
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Balint Erdi's blog about Ember.js</title>
  <meta name="author" content="Balint Erdi">

  
  <meta name="description" content="Ember.js screencasts, articles, best practice tips and more. Check out my blog and stay up-to-date on Ember.js">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NNRW2Q"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NNRW2Q');</script>
<!-- End Google Tag Manager -->


  
  <link rel="canonical" href="http://balinterdi.com/blog/page/6/index.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/balinterdi" rel="alternate" title="Balint Erdi's blog about Ember.js" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<script src="//load.sumome.com/" data-sumo-site-id="2f7f42a353353cbb47533e4a22a64e9c3ec9211f92d2320ff1130ad6c622ee03" async></script>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-12299794-2', 'balinterdi.com');
    ga('send', 'pageview');
  </script>


</head>

<body   >
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NNRW2Q"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <header role="banner"><hgroup>
  <h1><a href="/">I'm all about Ember.js recently</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/balinterdi" rel="home" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:balinterdi.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/01/14/how-real-time-updates-work-in-discourse.html">How Real-time Updates Work in Discourse</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-14T11:06:00+01:00" pubdate data-updated="true">Jan 14<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Given that I started engaging with web sites in the early 2000s there are still
some things today that I constantly marvel at. One of these things is real-live
update, the absolutely wonderful experience that I&#8217;m looking at a page and
it displays a change due to an action of another user right in front of my eyes,
without me hitting refresh.</p>

<p><a href="http://www.discourse.org/">Discourse</a>, being a state-of-the-art forum software does this, too,
and, provided my enthusiasm with all things that bring the web alive, I wanted to
understand how that works. More specifically I wanted to understand how
displaying new posts for the topic I am looking at can work its magic.</p>

<p>In the following post, I want to lead you through the whole process so that you
see exactly how the pieces fit together. In fact, that may be the thing I
enjoy most as a developer. Being able to take apart a complex application and
gain the comprehension of how the individual pieces function and how they are
orchestrated to make a complex system work.</p>

<h3>Tools</h3>

<p>Discourse is built on <a href="http://rubyonrails.org/">Ruby on Rails</a> and <a href="http://emberjs.com">Ember.js</a>, two fantasic
frameworks. Given my recent fascination with front-end development, and Ember.js
in particular, I&#8217;ll focus on the front-end part here and only talk about the
back-end mechanism as much as it is needed to see the whole picture.</p>

<p><em>Consequently, some knowledge about Ember.js is assumed. You can go through the <a href="http://emberjs.com/guides/getting-ember/">Getting Started</a> guide on the official Ember.js site or -if you prefer
showing to telling- <a href="http://emberjs.balinterdi.com">sign up to my mailing list</a> to watch a series
of screencasts to get a basic grip on Ember.js architecture as we go through the
building of an application.</em></p>

<h3>Message bus</h3>

<p>Discourse uses a ruby gem (library) called <a href="https://github.com/SamSaffron/message_bus">message_bus</a> that
enables listeners to subscribe to any channel of their liking and get notified
about events happening on that channel.</p>

<p>It also includes a <a href="https://github.com/SamSaffron/message_bus/blob/master/assets/message-bus.js">javascript lib</a> to allow connecting to the
message bus from the client-side application. That&#8217;s what Discourse uses from
the Ember.js app. Let&#8217;s see how.</p>

<h3>Subscribing to new posts on a topic</h3>

<p>When the user navigates to a topic page, the topic route gets activated and its
hooks run. After resolving the model, the <code>setupController</code> which, as its name
indicates, sets up the controller belonging to the model. It, among other
things, calls the subscribe method on the controller, see below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Discourse</span><span class="p">.</span><span class="nx">TopicRoute</span> <span class="o">=</span> <span class="nx">Discourse</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">setupController</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(...)</span>
</span><span class='line'>    <span class="nx">controller</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">();</span>
</span><span class='line'>    <span class="p">(...)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The controller for the model is Discourse.TopicController, so next we will look into
that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Discourse</span><span class="p">.</span><span class="nx">TopicController</span> <span class="o">=</span> <span class="nx">Discourse</span><span class="p">.</span><span class="nx">ObjectController</span><span class="p">.</span><span class="nx">extend</span><span class="p">(...,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">subscribe</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Unsubscribe before subscribing again</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">bus</span> <span class="o">=</span> <span class="nx">Discourse</span><span class="p">.</span><span class="nx">MessageBus</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">topicController</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">bus</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;/topic/&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">(...)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Add the new post into the stream</span>
</span><span class='line'>      <span class="nx">topicController</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;postStream&#39;</span><span class="p">).</span><span class="nx">triggerNewPostInStream</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">(...)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The controller subscribes to the channel <code>/topic/&lt;topic_id&gt;</code>. The client polls
the message bus for potential new messages every 15 seconds. You can see the XHR
calls in the console of your browser:</p>

<p><img src="/images/posts/discourse-real-updates/xhr-polls.png" alt="Polling the message bus" /></p>

<p>When something is published to that channel, the callback function gets called
back with the data related to that event. The data, in that case, is going to be
the new post record. When the callback is fired, we call the
triggerNewPostInStream method on the postStream with the id of the post. What
does triggerNewPostInStream do, then? We can check that in the PostStream model.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">  We use this class to keep on top of streaming and filtering posts within a topic.</span>
</span><span class='line'><span class="cm">**/</span>
</span><span class='line'><span class="nx">Discourse</span><span class="p">.</span><span class="nx">PostStream</span> <span class="o">=</span> <span class="nx">Em</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="p">(...)</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">    Finds and adds a post to the stream by id. Typically this would happen if we receive a message</span>
</span><span class='line'><span class="cm">    from the message bus indicating there&#39;s a new post. We&#39;ll only insert it if we currently</span>
</span><span class='line'><span class="cm">    have no filters.</span>
</span><span class='line'><span class="cm">  **/</span>
</span><span class='line'>  <span class="nx">triggerNewPostInStream</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(...)</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">loadedAllPosts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;loadedAllPosts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">).</span><span class="nx">addObject</span><span class="p">(</span><span class="nx">postId</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">loadedAllPosts</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">appendMore</span><span class="p">();</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The docstring is quite revealing. If the post id is already in the stream, we
don&#8217;t do anything. If it is not, we add it to the stream (an Ember array). If
the loading of posts has finished, we are ready to append the new posts to the
stream.</p>

<p>Notice we are adding post <em>ids</em>, not actual post records so the next
investigation step is to explore how ids get turned into records.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">  Appends the next window of posts to the stream. Call it when scrolling downwards.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">  @method appendMore</span>
</span><span class='line'><span class="cm">  @returns {Ember.Deferred} a promise that&#39;s resolved when the posts have been added.</span>
</span><span class='line'><span class="cm">**/</span>
</span><span class='line'><span class="nx">appendMore</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Make sure we can append more posts</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;canAppendMore&#39;</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">RSVP</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">postIds</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;nextWindow&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">postIds</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">RSVP</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;loadingBelow&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">stopLoading</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;loadingBelow&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">findPostsByIds</span><span class="p">(</span><span class="nx">postIds</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">posts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">posts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">appendPost</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">stopLoading</span><span class="p">();</span>
</span><span class='line'>  <span class="p">},</span> <span class="nx">stopLoading</span><span class="p">);</span>
</span><span class='line'><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above <code>appendMore</code> method is responsible for retrieving the post ids that
have to be added below the currently visible posts and turning these ids into
actual post records.</p>

<p>We are getting close now, but let me speed things up a bit by only explaining the
process but not showing all the code which makes it so that the new post objects
are finally pushed to the <code>posts</code> array from where they will be finally
displayed. (If you are such a code untangler as I am, and would like to see the
code, it is <a href="https://github.com/discourse/discourse/blob/0fd193fac314610d7a93d7b4af84a4bc1e52d03e/app/assets/javascripts/discourse/models/post_stream.js">right here</a>)</p>

<p>What happens is that the new posts get displayed in windows, not one by one.
This window is kept updated in the <code>nextWindow</code> property, from the stream we
pushed post ids into.  It is the slice in this stream that starts at the last
loaded post id and has a maximum length of <code>posts_per_page</code>, a configuration
setting.  This construct also makes it possible, quite ingeniously, for this
same code to load the next batch of posts to the page as the user scrolls down.</p>

<p>The window still contains ids and to fetch the related post records an identity
map (yes, Discourse has its <a href="http://balinterdi.com/2013/12/03/roll-your-own-ember-dot-js-identity-map.html">identity map implementation</a>,
too!) is used via the <code>findPostsByIds</code> method. Once the records are retrieved ,
they are each passed to the <code>appendPost</code> method that just pushes them to the
<code>posts</code> array.</p>

<h3>Displaying the new post in the topic stream</h3>

<p>The only thing remains to be seen for the whole picture to be clear is how the
stream of posts is displayed in the browser. The template that renders the
topic, along with its posts, is <a href="https://github.com/discourse/discourse/blob/0fd193fac314610d7a93d7b4af84a4bc1e52d03e/app/assets/javascripts/discourse/templates/topic.js.handlebars">the topic template</a>.</p>

<p>The relevant part of the template is below:</p>

<div>
  <pre><code class='html'>{{#unless postStream.loadingFilter}}
  {{cloaked-collection cloakView=&quot;post&quot; idProperty=&quot;post_number&quot; defaultHeight=&quot;200&quot; content=postStream.posts slackRatio=slackRatio}}
{{/unless}}</code></pre>
</div>


<p>If the post stream is not loading, we render the posts through the cloaked
collection. I will not go into details about what
<a href="https://github.com/eviltrout/ember-cloaking">cloaked-collection</a> does, (but I highly recommend <a href="http://eviltrout.com/2014/01/04/hiding-offscreen-ember.html">a blog
 post on it by its author, @eviltrout</a>), the important thing in the
current discussion is that it renders the <code>post</code> template (cloakView=&#8221;post&#8221;) for
each post from <code>postStream.posts</code> (content=postStream.posts).</p>

<p>That is where the two parts come together. Since a binding is established with
the above handlebars line to the posts property of the postStream, every time
new posts are added (see how in the first part of the walkthrough), the
collection is going to be rerendered and consequently the posts appear in
&#8220;real-time&#8221;. The magic of Ember.js bindings.</p>

<h3>In parting</h3>

<p>I skipped over a couple of things so that this post does not turn into a
chapter of a novel, but I hope that my walkthrough could let you peek behind
the curtains and see how such a miraculous feature is made possible.</p>

<p>The key takeaway is that building with the right tools (namely the message bus and
the solid foundations of Ember.js), which a lot of people have put an enormous
amount of time into, makes such a killer feature within your reach. Not easy,
but definitely doable.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/12/31/at-your-service-publicly-available-api-for-the-rock-and-roll-emberjs-app.html">At Your Service: Publicly Available API for the Rock and Roll Ember.js App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-31T09:38:00+01:00" pubdate data-updated="true">Dec 31<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So far, if you wanted to code along <a href="http://emberjs.balinterdi.com">my developing an example Ember.js
application</a>, Rock &amp; Roll, you had to run the server side
component. That required ruby to be installed on your machine, and you had to
<a href="https://github.com/balinterdi/rock-and-roll-api">clone the repository</a>, and start the server each time you wanted to
make some progress with the application.</p>

<p>I realized that might be cumbersome and thus I made the server publicly
available at http://rock-and-roll-with-emberjs-api.herokuapp.com .</p>

<p>I have also updated <a href="https://github.com/balinterdi/rock-and-roll/commit/remote-api">the client-side component to connect to that remote
api.</a>. All backend requests now go through App.Adapter.ajax which
basically just delegates to <code>Ember.$.ajax</code> prefixing urls with the backend host:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">Adapter</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">ajax</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;http://rock-and-roll-with-emberjs-api.herokuapp.com&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you work with an earlier version of the client app, you might have to
rewrite urls in multiple places but I figured it is still less work than running
the server yourself.</p>

<p>I hope that facilitates your working along with the Rock &amp; Roll app and makes
your journey to Ember.js proficiency smoother. If you want to see the
screencast series in which I develop said application, you can <a href="http://emberjs.balinterdi.com">sign up to my
mailing list</a> and have each episode auto-delivered to your inbox.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/12/17/change-the-url-type-of-your-ember-app.html">Changing the URL Type of Your Ember.js App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-17T09:32:00+01:00" pubdate data-updated="true">Dec 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>By default, Ember.js uses the hashchange event in the browser to change URLs.
This is the most widely supported way but it feels like a hack and there is a
better way, introduced in HTML5: <a href="http://diveintohtml5.info/history.html">the History API</a>.</p>

<p>Bear in mind that the <a href="http://caniuse.com/history">History API has a lower browser support
rate</a> than <a href="http://caniuse.com/hashchange">the hashchange
event</a> does (~70% vs.  89%), so there is a tradeoff
involved that you should decide to make or not to make.</p>

<p>Ember.js makes it really easy to change the URL type. All you have to do is
add the following lines to your client app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">reopen</span><span class="p">({</span>
</span><span class='line'> <span class="nx">location</span><span class="o">:</span> <span class="s1">&#39;history&#39;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Seems too good to be true (that is just the way Ember is), but provided you did
not assemble any routes manually and only used Ember&#8217;s tools to transition
between routes (e.g link-to, transitionTo, etc.), that is all the client-side
code changes you had to make.</p>

<p>The server side needs to be adjusted, too, though, since the server now gets
sent the client-side routes, too. How to do this can vary depending on the
application server you use.</p>

<p>In the case of the Rock &amp; Roll app, here is what <code>config.ru</code> looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">run</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># Extract the requested path from the request</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Utils</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;/artists&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">index_file</span> <span class="o">=</span> <span class="vi">@root</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/index.html&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">index_file</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># Return the index</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">},</span> <span class="o">[</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">index_file</span><span class="p">)</span><span class="o">]]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># Pass the request to the directory app</span>
</span><span class='line'>    <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Directory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@root</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I only had to add the <code>path.start_with?</code> condition to make sure the server
serves the Ember application on that route. It is not an ideal solution because
anytime you add a top-level route to the Ember app, you would also have to
modify the server config but this is the bare minimum that got the job done.</p>

<p>Hooray for clean URLs:
<img src="/images/posts/change-the-url-type/rock-and-roll-history-api-urls.png" alt="History API
URLs" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/12/11/build-an-ember-dot-js-app-with-firebase.html">Build an Ember.js App With Firebase</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-11T08:42:46+01:00" pubdate data-updated="true">Dec 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ember.js is an outstanding client-side framework for building single-page
applications. To make your application truly come to life, Firebase, being a
real-time backend, is a natural choice as the server-side component.</p>

<p>Sending data between the server and the client is a task all web applications
have to address. However, if one uses the Firebase-Ember.js stack, this
problem is largely abstracted away by these wonderful frameworks.</p>

<p>To make them work together, the Firebase team released their official
Ember.js bindings, <a href="https://github.com/firebase/emberFire">emberFire</a>.</p>

<h3>How does it work?</h3>

<p>Before we look at the making of the actual application it is important to
understand how the emberFire library works.</p>

<p>It is built on two primitives, <code>EmberFire.Object</code> and <code>EmberFire.Array</code>. These
extend <code>Ember.ObjectProxy</code> and <code>Ember.ArrayProxy</code>, respectively. These proxy
objects delegate any <code>get</code> and <code>setProperty</code> calls that are not defined on the
proxy to an underlying content object.</p>

<p>What this means is that we can work with Firebase references in our
application as if they were Ember objects. In the case of a single object,
setting a property will cause a child with that name to be written with the
passed value. When working with an array, the usual array methods (e.g
<code>pushObject</code>) can be used and they will do the right thing in the underlying
Firebase reference (e.g <code>push</code> the new node).</p>

<h3>Setting up the environment</h3>

<p>To set up the necessary dependencies, it is easiest to download the <a href="http://emberjs.com/">latest Ember
starter kit</a> and add the following script tags to the main
template:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://cdn.firebase.com/v0/firebase.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&#39;https://cdn.firebase.com/v0/firebase-simple-login.js&#39;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://firebase.github.io/emberFire/emberfire-latest.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>With that in place, we can start developing. For the sake of focusing on one
single issue at a time, the code snippets in this post do not always exactly
match those in the actual application. If you want to see them in their
entirety, you can always <a href="https://github.com/balinterdi/ideavote-emberfire">check the source code on Github</a>.</p>

<h3>The Idealist</h3>

<p>The application we are going to build is an &#8220;Idealist&#8221;. Users can submit ideas
and vote on existing ones.</p>

<p>When one loads the application it looks like the following:</p>

<p><img src="https://raw.github.com/balinterdi/ideavote-emberfire/master/public/img/screenshots/ideavote-screenshot-3-640.png" alt="Ideavote screenshot" /></p>

<p>A list of ideas is displayed along with the number of votes for that idea and a
button to vote that idea up.</p>

<p>To get the existing ideas from Firebase, we use the <code>model</code> hook of the
appropriate route:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">dbRoot</span> <span class="o">=</span> <span class="s2">&quot;https://emberfire-ideavote.firebaseio.com&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">ideasPath</span> <span class="o">=</span> <span class="nx">dbRoot</span> <span class="o">+</span> <span class="s2">&quot;/ideas&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">IdeasRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">model</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">EmberFire</span><span class="p">.</span><span class="nb">Array</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">ref</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Firebase</span><span class="p">(</span><span class="nx">ideasPath</span><span class="p">)</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This loads the ideas in an <code>EmberFire.Array</code> and then iterates through them in the <code>ideas</code> template:</p>

<div>
  <pre><code class='html'>&lt;script type=&quot;text/x-handlebars&quot; data-template-name=&quot;ideas&quot;&gt;
  {{ render &quot;ideas/new&quot; }}
  &lt;div class=&quot;idea-list&quot;&gt;
    &lt;ul class=&quot;unstyled&quot;&gt;
      {{#each controller}}
        {{ render &quot;idea&quot; this }}
      {{/each}}
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;/script&gt;</code></pre>
</div>


<p>So how does adding a new idea happen? If we take a look at the <code>ideas/new</code>
template, we can see that clicking on the &#8220;Send my idea&#8221; button triggers the
<code>sendIdea</code> action:</p>

<div>
  <pre><code class='html'>&lt;script type=&quot;text/x-handlebars&quot; data-template-name=&quot;ideas/new&quot;&gt;
  &lt;div class=&quot;idea new-idea&quot;&gt;
    &lt;div class=&quot;row&quot;&gt;
      &lt;div class=&quot;span9&quot;&gt;
        {{input value=title placeholder=&quot;Your idea here&quot; insert-newline=&quot;sendIdea&quot;}}
      &lt;/div&gt;
      &lt;div class=&quot;span2&quot;&gt;
        {{#if isDisabled}}
          &lt;button disabled=&quot;disabled&quot; {{bindAttr class=&quot;isDisabled:disabled&quot;}}&gt;Send my idea&lt;/button&gt;
        {{else}}
          &lt;button {{bindAttr class=&quot;isDisabled:disabled&quot;}} {{action sendIdea}}&gt;Send my idea&lt;/button&gt;
        {{/if}}
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/script&gt;</code></pre>
</div>


<p>The triggered <code>sendIdea</code> action is then handled on the controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">IdeasNewController</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ObjectController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">sendIdea</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">newIdeaRef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Firebase</span><span class="p">(</span><span class="nx">ideasPath</span><span class="p">).</span><span class="nx">push</span><span class="p">();</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">newIdea</span> <span class="o">=</span> <span class="nx">EmberFire</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">ref</span><span class="o">:</span> <span class="nx">newIdeaRef</span> <span class="p">});</span>
</span><span class='line'>      <span class="nx">newIdea</span><span class="p">.</span><span class="nx">setProperties</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">id</span><span class="o">:</span> <span class="nx">newIdeaRef</span><span class="p">.</span><span class="nx">name</span><span class="p">(),</span>
</span><span class='line'>        <span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">submittedBy</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;auth.currentUser.id&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">timestamp</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
</span><span class='line'>        <span class="nx">voteCount</span><span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>We get a reference with a unique id by using Firebase&#8217;s push operation. We
create an <code>EmberFire.Object</code> with that reference and that enables us to do our
magic with the help of Firebase. When we then set any property on the object,
it is going to be persisted on our backend and synchronized to all clients.</p>

<h3>Extending the EmberFire classes</h3>

<p>Up until this point, we did not need to create our own model classes. The basic
EmberFire classes were sufficient for our needs. However, if we need to define
additional behavior for our models, we have to extend these primitives.</p>

<p>Suppose, for example, that each user has a certain number of votes and we want
to prevent further voting when she does not have any votes left, as shown on the
next mockup:</p>

<p><img src="https://raw.github.com/balinterdi/ideavote-emberfire/master/public/img/screenshots/ideavote-screenshot-2-640.png" alt="Ideavote screenshot" /></p>

<p>We can define a computed property on the user that would tell whether she has
any votes left. Computed properties in Ember are properties that depend on
other -computed or &#8220;normal&#8221;- properties and get automatically updated when one of
the dependent properties change.</p>

<p>To do that, we need to define our User model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">User</span> <span class="o">=</span> <span class="nx">EmberFire</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">noVotesLeft</span><span class="o">:</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">computed</span><span class="p">.</span><span class="nx">lte</span><span class="p">(</span><span class="s1">&#39;votesLeft&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above is a computed macro definition that defines <code>noVotesLeft</code> as true if
the <code>votesLeft</code> property of the user is less than or equal to zero.</p>

<p>Then, in the template that renders each idea, we disable the button if that
computed property is true and also give it a grey hue to indicate its disabled
state:</p>

<div>
  <pre><code class='html'>&lt;script type=&quot;text/x-handlebars&quot; data-template-name=&quot;idea&quot;&gt;
  &lt;li&gt;
    &lt;div class=&quot;idea&quot;&gt;
      &lt;div class=&quot;row&quot;&gt;
        &lt;div class=&quot;span8&quot;&gt;
          &lt;strong&gt;{{title}}&lt;/strong&gt;
        &lt;/div&gt;
        &lt;div class=&quot;span1&quot;&gt;
          {{voteCount}}
        &lt;/div&gt;
          &lt;div class=&quot;span2&quot;&gt;
            &lt;button {{bind-attr class=&quot;:btn auth.currentUser.noVotesLeft:btn-disabled:btn-primary&quot;}}
                    {{bind-attr disabled=&quot;auth.currentUser.noVotesLeft&quot;}}&gt;Vote&lt;/button&gt;
          &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/li&gt;
&lt;/script&gt;</code></pre>
</div>


<p>Keep in mind that the context of the template is an idea and our computed
property is defined on the user, hence the need for
<code>auth.currentUser.noVotesLeft</code>.</p>

<h3>Wait, there is more</h3>

<p>Taking things a step further, I have also integrated Firebase&#8217;s SimpleLogin
authentication service and prevented the same user to vote on the same idea
multiple times. If you wish to see how these are implemented, I encourage you to
check out <a href="https://github.com/balinterdi/ideavote-emberfire">the source code of the project</a>.</p>

<p>I hope I got you interested in learning more about how to build real-time web
applications and gave you a basic example of how to use state-of-the-art tools
to do so.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/12/03/roll-your-own-ember-dot-js-identity-map.html">Roll Your Own Ember.js Identity Map</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-03T11:41:00+01:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you followed along my <a href="http://emberjs.balinterdi.com">Build an Ember app screencast series</a> and maybe
played around <a href="https://github.com/balinterdi/rock-and-roll/releases/tag/episode-7">with the app</a> on your own, you might have
noticed a subtle bug in the application.</p>

<p>When you load the application on the <code>/artists/</code> route and then choose one of
the artists, the artist link gets highlighted correctly:</p>

<p><img src="/images/posts/roll-your-own-store/active-highlight-works.png" alt="Correct active highlight" /></p>

<p>However, when you reload the app on one of these artists routes (e.g
<code>/artists/pearl-jam</code>), the artist link does not get the active highlight:</p>

<p><img src="/images/posts/roll-your-own-store/active-highlight-does-not-work.png" alt="Incorrect active highlight" /></p>

<h3>Understanding what is wrong</h3>

<p>The first step of any debugging process is to understand where the bug lies. In
order to do that we have to understand how highlighting a link as active works
in Ember.js.</p>

<p>I wrote about this topic in detail in <a href="http://blog.safaribooksonline.com/2013/10/29/marking-links-as-active-in-ember-js-markdown/">a guest post</a> so let
me just quickly summarize it here.</p>

<p>The artist links are rendered using the <code>link-to</code> helper. When active routes
change (that includes the moment when the app is loaded from scratch) the
<code>isActive</code> property for each link is recomputed. If it is found to be
active, the activeClass is added to the view&#8217;s tag and that enables it to be
displayed differently.</p>

<p>When is a link-to active? When its route name matches one of the current route
names. This is pretty straightforward for static links but what about dynamic ones
with context objects? In those cases, all the context objects have to match in
order for the link to be considered active.</p>

<p>Let&#8217;s see our particular case. We have the following routes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">resource</span><span class="p">(</span><span class="s1">&#39;artists&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;songs&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;:slug&#39;</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the following template that renders each artist link:</p>

<div>
  <pre><code class='html'>&lt;script type=&quot;text/x-handlebars&quot; data-template-name=&quot;artists&quot;&gt;
  (...)
  {{#each model}}
    {{#link-to &quot;artists.songs&quot; this class=&quot;list-group-item artist-link&quot;}}
      {{name}}
      (...)
    {{/link-to}}
  {{/each}}
  (...)
&lt;/script&gt;</code></pre>
</div>


<p>Each link is rendered with an artist object that comes from the model hook of
the <code>ArtistsRoute</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">ArtistsRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">model</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">artistObjects</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">A</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;http://localhost:9393/artists&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">artists</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">artistObjects</span><span class="p">.</span><span class="nx">pushObject</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">Artist</span><span class="p">.</span><span class="nx">createRecord</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">artistObjects</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">(...)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the artist object that serves as the context for the <code>artists.songs</code> link has
to be the exact same object as the one returned from the model hook of the
<code>ArtistsSongsRoute</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">ArtistsSongsRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">model</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">artist</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Artist</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:9393/artists/&#39;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">.</span><span class="nx">slug</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">artist</span><span class="p">.</span><span class="nx">setProperties</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">id</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">songs</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Artist</span><span class="p">.</span><span class="nx">extractSongs</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">songs</span><span class="p">,</span> <span class="nx">artist</span><span class="p">)</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">artist</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">(...)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Are they identical? Well, intuitively they are but Ember.js does not care about
our intuition and so we should not, either. They are different objects since
both were created by calls to <code>App.Artist.create</code> (<code>App.Artist.createRecord</code>
calls <code>App.Artist.create</code> under the hood) which returns a new object
every time. Bummer.</p>

<h3>Replacing intuition with reality</h3>

<p>Don&#8217;t be sad, it&#8217;s not bad.</p>

<p>What we need is to have the same model object to be returned for the same
identifier. In the matter at hand, given an artist slug (that serves as an
identifier) we want to get back the same <code>App.Artist</code> object every time we use it.</p>

<p>If you think about it, that&#8217;s what identity maps are for.</p>

<h3>Wiring it up with promises</h3>

<p>The identity map needs to be able to retrieve objects and also store them. Most
importantly, it has to return the object from its map if it has already created
it with the passed in id.</p>

<p>I will dump the code below and then explain what it does:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">IdentityMap</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">map</span><span class="o">:</span> <span class="p">{},</span>
</span><span class='line'>  <span class="nx">findAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">identityMap</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">RSVP</span><span class="p">.</span><span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;http://localhost:9393/artists&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">artists</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">artistObjects</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">A</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">artists</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">artist</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Artist</span><span class="p">.</span><span class="nx">createRecord</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">identityMap</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s1">&#39;artist&#39;</span><span class="p">,</span> <span class="nx">artist</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;slug&#39;</span><span class="p">),</span> <span class="nx">artist</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">artistObjects</span><span class="p">.</span><span class="nx">pushObject</span><span class="p">(</span><span class="nx">artist</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="nx">resolve</span><span class="p">(</span><span class="nx">artistObjects</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">find</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">identityMap</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">RSVP</span><span class="p">.</span><span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">artist</span> <span class="o">=</span> <span class="nx">identityMap</span><span class="p">.</span><span class="nx">map</span><span class="p">[</span><span class="nx">identityMap</span><span class="p">.</span><span class="nx">_key</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)];</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">artist</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">resolve</span><span class="p">(</span><span class="nx">artist</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:9393/artists/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">Ember</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">artist</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Artist</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">artist</span><span class="p">.</span><span class="nx">setProperties</span><span class="p">({</span>
</span><span class='line'>            <span class="nx">id</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">songs</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Artist</span><span class="p">.</span><span class="nx">extractSongs</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">songs</span><span class="p">,</span> <span class="nx">artist</span><span class="p">)</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>          <span class="nx">identityMap</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s1">&#39;artist&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">artist</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">resolve</span><span class="p">(</span><span class="nx">artist</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">(...)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, I used promises for the retrieval methods of the API.</p>

<p>Promises are a huge improvement over callbacks and deserve their own
<del>article</del> book. They represent eventual values that are going to be
either resolved (meaning success) or rejected (meaning failure) and can be
passed around freely.</p>

<p>Ember.js relies on promises heavily in its <a href="http://emberjs.com/guides/routing/asynchronous-routing/#toc_a-word-on-promises">routing API</a> and uses
<a href="https://github.com/tildeio/rsvp.js">the rsvp promise library</a>. If a promise is returned from any <code>model</code> hook,
the route transition does not begin until <a href="http://emberjs.com/guides/routing/asynchronous-routing/#toc_the-router-pauses-for-promises">the promise is resolved</a>.</p>

<p>Leveraging that property of Ember routing I return promises from both the
<code>findAll</code> and <code>find</code> methods and then use them from the model hooks of
the appropriate routes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">ArtistsRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">model</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">App</span><span class="p">.</span><span class="nx">IdentityMap</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="s1">&#39;artist&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">(...)</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">ArtistsSongsRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">model</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">App</span><span class="p">.</span><span class="nx">IdentityMap</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;artist&#39;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">slug</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">(...)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I call <code>App.IdentityMap.findAll</code> from the <code>ArtistsRoute</code> the rendering of
the <code>artists</code> template is stopped until the promise is resolved. That happens
when the AJAX call has returned with the data for all artists and I call
<code>resolve(artistObjects)</code>.</p>

<p>Next, the model hook for the <code>ArtistsSongsRoute</code> is evaluated. It returns a
promise that has to be resolved in order for the template to be rendered.</p>

<p>The artist is found in the identityMap because it has just been stored there
during the findAll in the previous model hook resolution (see the
<code>identityMap.store('artist', artist.get('slug'), artist);</code> line). Since it is
the same object that was used as the context for the artist link, the bug is
squashed.</p>

<p>The link now gets correctly highlighted as active:</p>

<p><img src="/images/posts/roll-your-own-store/active-highlight-fixed.png" alt="Active highlight fixed" /></p>

<p>Notice we achieved something else, too. Instead of firing two AJAX calls, one
to fetch all artists and then one to fetch the one serialized in the URL we now
only have one call. We eliminated the second one by returning the object from
the identity map.</p>

<p>Furthermore, I also think our code has become better organized. The models for
our routes have now become one-liners and can quickly be read and understood at
a casual glance instead of being buried under the minutiae of AJAX calls.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/11/27/profile-your-ember-app-with-ember-renderspeed.html">Profile Your Ember App With Ember-renderspeed</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-27T18:56:00+01:00" pubdate data-updated="true">Nov 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If your application has lots of things going on or you render a large list, you
might see your once snappy app lose some of that swiftness. Naturally, you want
to speed your application up and the first thing to do in these cases is to know
where the bottlenecks are.</p>

<p>One solution to this is to integrate <a href="https://github.com/eviltrout/ember-renderspeed">ember-renderspeed</a>, a very simple library
released by the Discourse team. It shows the rendering time of your templates
and views on your development console, in a nicely nested form. Don&#8217;t get
frightened by the verb &#8220;integrate&#8221;. It is as easy as <a href="https://raw.github.com/eviltrout/ember-renderspeed/master/ember-renderspeed.js">downloading the js file</a> and
adding a script tag to it.</p>

<p>Once you did that, open your Javascript console in your browser, reload the page
and observe the profile of your application. It is enabled by default on the
Ember discussion forum, so you can take a look there. You will see something
like the following:</p>

<p><img src="/images/ember-renderspeed-screenshot.png" alt="ember-renderspeed screenshot" /></p>

<p>Under the hood, ember-renderspeed uses <a href="http://emberjs.com/api/classes/Ember.Instrumentation.html">Ember&#8217;s instrumentation facilities</a>, so
should ember-renderspeed not work for your problem, you can always roll your own
or use a third-party service, like <a href="http://caliper.io/">Caliper</a>.</p>

<p>That said, ember-renderspeed is a very quick and easy way to profile your app
and can be the first tool you reach for when the need arises.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/08/23/find-and-replace-in-all-files.html">Find and Replace in All Files</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-23T22:01:00+02:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You want to change a string with another one in some directory in your project.</p>

<p>Here is a one liner to do that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>for spec_file in $(ag -g _spec.rb spec/); do sed -i.bak 's/john/jane/g' $spec_file; done</span></code></pre></td></tr></table></div></figure>


<p>A few caveats:</p>

<ul>
<li>The match should be case-insensitive. Unfortunately, <code>s/john/jane/gI</code> does not
work under OSX.</li>
<li>The -i tells sed to do an in-place replacement. Again, under OSX, however, you
must give an extension for the backup files. A <code>git clean -f</code> can get rid of
these in one fell swoop.</li>
<li>You can use <code>find spec/ -name '_spec.rb'</code> instead of the ag command. <a href="http://geoff.greer.fm/2011/12/27/the-silver-searcher-better-than-ack/">But why
would you?</a></li>
</ul>


<p>(If you know how to do the replacement with awk, or something similar, please
tell me in the comments.)</p>

<p>Your text editor might already have a <code>Find &amp; Replace in project</code> functionality.
But maybe it does not. And surely, the command line version is most flexible.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/06/19/the-appeal-of-one-paradigm-languages.html">The Appeal of One Paradigm Languages</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-19T23:19:00+02:00" pubdate data-updated="true">Jun 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I was preparing for <a href="https://speakerdeck.com/balint/clojure-data-structures-part-one">my presentation on Clojure data structures</a> I flashed
back to a recent programming task I had to overcome. I don&#8217;t remember exactly
what it was but it involved grouping data by particular keys and having an array
of values for each key. When such a task rears its head I always have to play
around in the REPL (err, the browser console) to see the exact working of each
function I am about to rely on.</p>

<p>Which one changes the array I call it on? Which one returns the new value and
leaves the original intact? What about taking two arrays to make a third one?
Javascript being slightly OOish, may I possibly use the + operator to join them
together?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">];</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>      <span class="c1">// x = [1,2,3]; y = 3;</span>
</span><span class='line'><span class="nx">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">];</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="mi">3</span><span class="p">]);</span>  <span class="c1">// x = [1,2]; y = [1,2,3]</span>
</span><span class='line'><span class="nx">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">];</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>    <span class="c1">// x = [1,2]; y = [1,2,3]</span>
</span><span class='line'><span class="nx">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">];</span> <span class="nx">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span> <span class="c1">// z = &quot;1,23&quot; WAT?</span>
</span></code></pre></td></tr></table></div></figure>


<p>I spend a considerable amount of time trying these out and since I discover no
overarching design behind how they operate I come away none-the-wiser and so
repeat the same process on a slighly different problem some time later. (slice
vs. splice, anyone?)</p>

<p>Before I bash on javascript some more, I find it important to state that
it&#8217;s an enormous feat <a href="http://www.w3.org/community/webed/wiki/A_Short_History_of_JavaScript">to design and implement a language in ten days</a>,
hat tip to Brendan Eich.</p>

<p>The point I want to get across is that not having a solid design principle
behind a language is actually a hindrance. It slows you down by having to try
the pieces (functions, in this case) individually unless you have memorized
them.</p>

<p>On the other hand, when you work with a language that has a design philosophy
you gain the benefit of faster development. In Clojure, in the case of
collection types, that principle is immutability. You don&#8217;t have to read the
docs or fiddle around in the REPL. The original never changes, you get the
&#8220;modified&#8221; version in the returned value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">])</span> <span class="p">(</span><span class="k">def </span><span class="nv">y</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">x</span> <span class="mi">3</span><span class="p">))</span> <span class="c1">; x = [1,2]; y=[1,2,3]</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">])</span> <span class="p">(</span><span class="k">def </span><span class="nv">y</span> <span class="p">(</span><span class="nb">concat </span><span class="nv">x</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="c1">; x [1,2]; y=[1,2,3]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s look at another language, Ruby.</p>

<p>Called on an array, <code>push</code>, <code>concat</code>, <code>shift</code>, <code>pop</code> and <code>unshift</code> all modify
their caller. <code>Push</code>, <code>concat</code> and <code>unshift</code> return the modified array, while
<code>shift</code> and <code>pop</code> return the removed element.  So the rule seems to be that
methods that expand the array return the new array, methods that take away an
element return that element. So far so good.</p>

<p>What about <code>take</code> and <code>drop</code>? They both take away a number of elements, from the
beginning or from the end, and the number of elements being passed in as a
parameter. I&#8217;d totally expect these methods to change the original in place.
After all, few names sound more destructive than <code>drop</code>.  We&#8217;re in for a
surprise. Both of them leave the original intact and return the taken (or
dropped elements). In fact, you can pass in a number to both <code>shift</code> and <code>pop</code>
which makes them identical to <code>take</code> and <code>drop</code> with the important distinction
of whether they mutate or not the array they are called on.</p>

<p>To add to the confusion, there is <code>delete</code> which deletes all occurrences of the
element that is given as the parameter and there is <code>compact</code> which does exactly
the same for a special case, nil. (So <code>compact</code> takes no parameter). However,
it turns out that <code>delete</code> is mutating, but <code>compact</code> is not, preferring to return
the array with no nils. <code>compact!</code> comes to the rescue which does mutation and so
<code>x.compact!</code> is the same <code>x.delete(nil)</code>.</p>

<p>To give an analogy from natural languages, learning operations on collections in
Ruby and Javascript is like learning the article for each noun in German (der,
die or das). There are rules but they are hard to remember in the first place
and are often violated.</p>

<p>Learning the same thing in Clojure is like learning articles in English: there
is one true way to do it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/06/02/install-ruby-2-dot-0-0-with-rbenv-ruby-build-on-mountain-lion.html">Install Ruby 2.0.0 With Rbenv (Ruby-build) on Mountain Lion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-02T22:58:00+02:00" pubdate data-updated="true">Jun 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ol>
<li>You need to <a href="http://www.ruby-lang.org/en/news/2013/05/14/ruby-2-0-0-p195-is-released/">download the source</a>, or use <a href="https://github.com/sstephenson/ruby-build">ruby-build</a> to install it for you. I will subsequently suppose the latter.</li>
<li>You need to configure it, compile it and copy files to the proper location:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RUBY_CONFIGURE_OPTS=--with-openssl-dir=`brew --prefix openssl` CONFIGURE_OPTS=--with-gcc=clang rbenv install 2.0.0-p195</span></code></pre></td></tr></table></div></figure>


<p>You can see I installed openssl through homebrew. The ruby-build recipe
downloads an openssl lib for you so only use that if you have it
installed as I do.</p>

<p>I got the clang compiler frontend through <a href="https://developer.apple.com">Apple&#8217;s Command Line
Tools</a> so I&#8217;m not sure that&#8217;s needed if you have the whole Xcode
package.</p>

<p>It really feels faster -maybe due to the improved GC-, rails starts >2
as fast as compared to plain 1.9.3, using <a href="https://github.com/jonleighton/spring">spring</a> in both cases.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/05/30/ruby-rogues-discourse-with-jeff-atwood.html">Ruby Rogues - Discourse With Jeff Atwood</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-30T21:23:00+02:00" pubdate data-updated="true">May 30<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://itunes.apple.com/us/podcast/ruby-rogues/id436260381">Ruby Rogues</a> is one of the handful of podcasts I usually listen to. This week featured Jeff Atwood who talked about
Discourse, a phenomenal forum platform. Jeff&#8217;s thoughts on several things really struck home so I wanted to jot them down.
You might find these thought-provoking, too. The full transcription is available <a href="http://rubyrogues.com/106-rr-discourse-with-jeff-atwood/#more-1341">here</a></p>

<ul>
<li>Installing a binary app per device is a huge step backward from the web world where you don&#8217;t have to download and upgrade anything. You just go to the website and it works.</li>
<li>Betting on Javascript is a very safe bet. The competition has been the fiercest among browser performances, that is Javascript engines on the client. The engines are guaranteed to improve.</li>
<li>Desktop computers are -in most cases- more performant than the server the application is hosted on. So it makes sense to push computations to the clients, and spread it out among them.</li>
<li>[Discourse] using postgres is a way to force hosting providers move out of the &#8220;server herpes&#8221; (PHP + MySQL). As Discourse becomes more popular, this will give more leverage to remove the herpes from servers.</li>
<li>Why was it [the server side] built in Ruby/Rails? <a href="http://eviltrout.com/">Robin Ward</a> made a game about forums and Jeff contacted him to build Discourse. Robin had used Ruby and thus this decided the Ruby or Python question.</li>
<li>Rule of 3. Kind of a philoshopical belief for Jeff. A component (e.g a datepicker) is proven to be reusable if it was successfully used in three different contexts. Having three major partners for Discourse will really be a tipping point. Etc.</li>
<li>Since Discourse is mainly a rich, client-side app, <a href="http://emberjs.com">Ember</a> plays a much bigger role in its success (or failure) then Ruby. The question is how will Rubyists adapt to Ember, whether they will like it or not.</li>
</ul>


<p>Discourse is built on Ember, and <a href="http://discuss.emberjs.com/">Ember uses Discourse as a forum</a>. For one, I welcome our new rich-client overlords.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/5/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Master Authentication in Ember</h1>
  <div>
    <a href="https://www.embermeetup.com/rock-and-roll-ember/?utm_source=balinterdi.com&utm_medium=sidebar&utm_campaign=rarwe-auth-workshop" style="text-decoration:none">
      <img src="/images/RARE-Gabby.svg" alt="GEM Authentication workshop" title="GEM Authentication workshop" />
    </a>
  </div>
</section>
<section>
  <h1>Learn Ember from the most up-to-date book</h1>
  <div>
    <a href="http://rockandrollwithemberjs.com/?utm_source=my-blog&utm_medium=sidebar&utm_campaign=rarwe-book" style="text-decoration:none">
      <img src="/images/rarwe-book.jpg" alt="Rock and Roll with Ember.js" title="Rock and Roll with Ember.js" />
    </a>
  </div>
</section>
<section>
  <h1>Contact</h1>
  <div style="margin-top:10px">
    I do Ember.js consulting. If you have a project that needs help, <a href="mailto:balint@balinterdi.com">contact me</a> and let&#8217;s start talking.
  </div>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/11/29/two-way-symmetric-relationships-in-ember-with-jsonapi-part-2.html">Two-way symmetric relationships in Ember with JSON API - Part 2</a>
      </li>
    
      <li class="post">
        <a href="/2016/11/17/two-way-symmetric-relationships-in-ember-with-jsonapi-part-1.html">Two-way symmetric relationships in Ember with JSON API - Part 1</a>
      </li>
    
      <li class="post">
        <a href="/2016/11/16/rock-and-roll-with-ember-dot-js-2-dot-9-is-released.html">Rock and Roll with Ember.js 2.9 is released</a>
      </li>
    
      <li class="post">
        <a href="/2016/11/11/enable-fastboot-in-your-ember-app.html">Enable FastBoot in your Ember app</a>
      </li>
    
      <li class="post">
        <a href="/2016/10/17/continuous-visual-integration-for-ember-apps.html">Continuous Visual Integration for Ember apps</a>
      </li>
    
  </ul>
</section>
<section class="codementor">
  <script data-codementor="balint" data-style="button" data-theme="dark" src="https://cdn.codementor.io/d/badge.js"></script>
</section>


<section>
  
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/baaz" class="twitter-follow-button" data-show-count="false">Follow @baaz</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Balint Erdi -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codigoergosum';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<script src="/javascripts/app.js"></script>




</body>
</html>
